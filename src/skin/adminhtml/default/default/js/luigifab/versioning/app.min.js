/**
 * Copyright 2011-2020 | Fabrice Creuzot (luigifab) <code~luigifab~fr>
 * https://www.luigifab.fr/openmage/versioning
 * This program is free software, you can redistribute it or modify
 * it under the terms of the GNU General Public License (GPL).
 */
window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=function(t,e,o){for(e=e||window,o=0;o<this.length;o++)t.call(e,this[o],o,this)});var versioning=new function(){"use strict";this.svg=null,this.width=197,this.start=function(){document.getElementById("versioning_grid_table")?(console.info("versioning.app - hello"),this.drawGraph(self.versioningIds,self.versioningCols).startDiff()):document.getElementById("versioning_history_grid_table")&&document.querySelector("table.data tbody button")&&(console.info("versioning.app - hello"),document.querySelector("table.data tbody button").click())},this.loader=function(){document.querySelector("body").classList.add("progress")},this.decode=function(t){return decodeURIComponent(escape(self.atob(t)))},this.confirmFlag=function(e,t,o){try{if(apijs.version<530)throw new Error("Invalid apijs version");apijs.dialog.dialogConfirmation(t,this.decode(o),versioning.actionConfirmFlag,e,"notransition versioning "+document.getElementById("scmtype").textContent);var i=document.createElement("p");return i.setAttribute("class","credits"),i.appendChild(document.createTextNode(self.versioningText[1])),apijs.dialog.t1.appendChild(i),!1}catch(t){console.error(t);try{apijs.dialog.actionClose()}catch(t){}try{return!!confirm(this.decode(o).replace(/\[[^\]]+]/g,""))&&(this.loader(),self.location.href=e,!0)}catch(t){return console.error(t),!!confirm(Translator.translate("Are you sure?"))&&(this.loader(),self.location.href=e,!0)}}},this.actionConfirmFlag=function(t){versioning.loader(),apijs.version<600?apijs.dialog.styles.remove("waiting","lock"):apijs.dialog.remove("waiting","lock"),self.location.href=t},this.cancelFlag=function(t){this.loader(),self.location.href=t},this.confirmUpgrade=function(e,o){var i=self.versioningText[0],r=self.versioningText[1];try{if(apijs.version<530)throw new Error("Invalid apijs version");e.match(/revision\/(\w+)\//),apijs.dialog.dialogFormOptions(o.replace("ยง",RegExp.$1),this.decode(i),e,versioning.actionConfirmUpgrade,null,"notransition versioning "+document.getElementById("scmtype").textContent);var t=document.createElement("p");return t.setAttribute("class","credits"),t.appendChild(document.createTextNode(r)),apijs.dialog.t1.appendChild(t),!1}catch(t){console.error(t);try{apijs.dialog.actionClose()}catch(t){}try{var n=document.createElement("div"),s=this.decode(i).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\[/g,"<").replace(/]/g,">"),a=document.getElementById("scmtype").textContent;return e.match(/revision\/(\w+)\//),n.innerHTML='<div class="fake options versioning '+a+' ready" id="apijsDialog"><form method="get" action="'+e+'" class="fake options versioning '+a+' ready" onsubmit="return versioning.actionConfirmUpgrade(true);" id="apijsBox"><h1>'+o.replace("ยง",RegExp.$1)+'</h1><div class="bbcode">'+s+'</div><div class="control"><button type="submit" class="confirm">Valider</button><button type="button" class="cancel" onclick="versioning.closeConfirmUpgrade();">Annuler</button></div></form><p class="credits">'+r+"</p></div>",document.querySelector("body").appendChild(n),document.querySelector("div.bbcode input").focus(),!1}catch(t){return console.error(t),!!confirm(Translator.translate("Are you sure?"))&&(this.loader(),!0)}}},this.closeConfirmUpgrade=function(){document.getElementById("apijsDialog").parentNode.removeChild(document.getElementById("apijsDialog"))},this.actionConfirmUpgrade=function(t){return!1===t||(versioning.loader(),!0===t?(document.querySelector("div.bbcode").setAttribute("style","visibility:hidden;"),document.querySelector("div.control").setAttribute("style","visibility:hidden;")):(apijs.version<600?apijs.dialog.styles.remove("waiting","lock"):apijs.dialog.remove("waiting","lock"),self.location.href=t+apijs.serialize(document.getElementById("apijsBox")).replace(/[=&]/g,"/"))),!0},this.history=function(t,e){return document.querySelectorAll("table.data tbody tr[class]").forEach(function(t){t.classList.remove("current")}),document.querySelector("pre").innerHTML=this.decode(e)+"\n\n",t.parentNode.parentNode.classList.add("current"),!1},this.drawGraph=function(i,t){var r,n,s,a,l,c="",e=Object.keys(i).map(function(t){return i[t]}),d=$$("table.data tbody tr"),u=d.length-1,o=[],h=[],g=[],p=[],f=[],m=0,v=0,y=0,b=0,k=0,w=0;for(e.sort(function(t,e){return t.row>e.row?-1:t.row<e.row?1:0}),y="function"==typeof Element.Layout?(v=d.first().getLayout().get("top")-1,d.last().getLayout().get("top")+d.last().getLayout().get("height")-v-1):(v=Element.positionedOffset(d.first())[1]-1,Element.positionedOffset(d.last())[1]+d.last().getDimensions().height-v-1),this.svg=new Raphael(document.getElementById("versioning_grid_table").parentNode),this.svg.setSize(this.width,y),this.svg.canvas.setAttribute("style","top:"+v+"px;"),this.svg.canvas.setAttribute("class","k k0"),this.svg.canvas.setAttribute("id","versioning_graph"),this.svg.canvas.setAttribute("onmouseover","versioning.mouseOver(true);"),this.svg.canvas.parentNode.setAttribute("onmouseleave","versioning.mouseOver(false);"),Raphael.getColor.reset(),Raphael.getColor(),o.push(Raphael.getColor()),r=0;r<=t;r++)Raphael.getColor(),Raphael.getColor(),o.push(Raphael.getColor()),h.push("svg.k"+r+" .k:not(.k"+r+") { opacity:0.4; }"),h.push("table.k"+r+" .k:not(.k"+r+") { color:#CCC; }"),h.push("table.k"+r+" .k:not(.k"+r+") button { opacity:0; visibility:hidden; }");return e.forEach(function(t){t.color=o[t.col],t.klass="k k"+t.col,f[t.col]=t.revision,p[t.col]||(p[t.col]=t.revision)}),e.forEach(function(o){k="function"==typeof Element.Layout?(b=d[u-o.row].getLayout().get("top")-v,d[u-o.row].getLayout().get("height")/2):(b=Element.positionedOffset(d[u-o.row])[1]-v,d[u-o.row].getDimensions().height/2),n=b+k,r=25*o.col+20,this.svg.circle(r,n,3.5).attr("fill",o.color).attr("stroke","none").attr("class",o.klass),0<o.branch.length&&g.indexOf(o.branch)<0&&(g.push(o.branch),l=this.svg.text(r+13,n-.3,o.branch).attr("fill",o.color).attr("text-anchor","start").attr("class",o.klass),s=r+3.2+8+l.getBBox().width+7,this.svg.path("M "+(r+3.2)+","+(n-.4)+" L "+(r+3.2+8)+","+(n-.4-8)+" L "+s+","+(n-.4-8)+" L "+s+","+(n-.4+8)+" L "+(r+3.2+8)+","+(n-.4+8)+" Z").attr("stroke",o.color).attr("fill","white").attr("fill-opacity","0.7").attr("stroke-opacity","0.2").attr("class",o.klass).toFront(),l.toFront(),s>this.width&&(this.width=s)),o.parents.forEach(function(t,e){"object"==typeof(e=0<t.length?i[t]:void 0)?(k="function"==typeof Element.Layout?(b=d[u-e.row].getLayout().get("top")-v,d[u-e.row].getLayout().get("height")/2):(b=Element.positionedOffset(d[u-e.row])[1]-v,d[u-e.row].getDimensions().height/2),a=b+k,s=25*e.col+20,e.col===o.col?this.svg.path(["M",r,n,"V",a]).attr("stroke",o.color).attr("stroke-width",1.7).attr("class",o.klass).toBack():(c+='<linearGradient id="manGrad'+m+'" x1="0" y1="0" x2="100%" y2="0"><stop offset="0" stop-color="'+(s<r?e.color:o.color)+'"></stop><stop offset="100%" stop-color="'+(s<r?o.color:e.color)+'"></stop></linearGradient>',w="function"==typeof Element.Layout?d[u-e.row].getLayout().get("height")/2:d[u-e.row].getDimensions().height/2,w+=k,e.revision===p[e.col]&&n+w<a?((l=this.svg.path(["M",r,n,"T",s,n+w])).node.setAttribute("stroke","url(#manGrad"+m+")"),l.attr("stroke-width",1.6).attr("class","k").toBack(),this.svg.path(["M",s,n+w,"V",a]).attr("stroke",e.color).attr("stroke-width",1.7).attr("class","k").toBack()):(o.revision===f[o.col]&&n+w<a&&1===o.parents.length?(this.svg.path(["M",r,n,"V",a-w]).attr("stroke",o.color).attr("stroke-width",1.7).attr("class","k").toBack(),(l=this.svg.path(["M",r,a-w,"T",s,a])).node.setAttribute("stroke","url(#manGrad"+m+")")):(l=this.svg.path(["M",r,n,"T",s,a])).node.setAttribute("stroke","url(#manGrad"+m+")"),l.attr("stroke-width",1.6).attr("class","k").toBack()),m+=1)):0<t.length&&this.svg.path(["M",r,n,"V",y]).attr("stroke",o.color).attr("stroke-width",1.7).attr("class",o.klass).toBack()},this),(l=d[u-o.row]).setAttribute("onclick","versioning.updateClass(this.getAttribute('class'));"),l.setAttribute("class",o.row%2<1?o.klass:"even "+o.klass),l.removeAttribute("title")},this),0<c.length&&(document.querySelector("svg defs").innerSVG=c),(l=document.createElement("style")).setAttribute("type","text/css"),l.setAttribute("id","versioning_styles"),l.appendChild(document.createTextNode(h.join("\n"))),document.querySelector("head").appendChild(l),this},this.mouseOver=function(t){this.svg.canvas.style.width=t?this.width+"px":"197px",this.svg.canvas.style.pointerEvents=t?"none":"inherit"},this.updateClass=function(t){this.svg.canvas.setAttribute("class",t),document.getElementById("versioning_grid_table").setAttribute("class","data "+t)},this.startDiff=function(){var e=1,o=1,i=!0;return document.querySelectorAll('table.data input[type="radio"]').forEach(function(t){t.setAttribute("onchange","versioning.goDiff("+(i?e++:o++)+", "+(i?"false":"true")+");"),t.removeAttribute("disabled"),i=!i}),document.querySelector('table.data tr:last-child input[name="d1"]').setAttribute("disabled","disabled"),document.querySelector('table.data tr:first-child input[name="d2"]').setAttribute("disabled","disabled"),document.querySelector('table.data input[name="d1"]:not([disabled])').checked=!0,document.querySelector('table.data input[name="d2"]:not([disabled])').checked=!0,this.goDiff()},this.goDiff=function(t,e){var o,i=document.querySelector('table.data input[name="d1"]:checked'),r=document.querySelector('table.data input[name="d2"]:checked'),n=parseInt(i.getAttribute("onchange").replace(/\D/g,""),10),s=parseInt(r.getAttribute("onchange").replace(/\D/g,""),10);return"string"==typeof t?(this.loader(),self.location.href=t):(!0===e?s<=n&&((i=r.parentNode.parentNode.previousElementSibling.querySelector('input[name="d1"]')).checked=!0):s<=n&&((r=i.parentNode.parentNode.nextElementSibling.querySelector('input[name="d2"]')).checked=!0),o=(o=(o=document.querySelector("div.content-header td.form-buttons button").getAttribute("onclick")).replace(/\/from\/[^\/]+/,"/from/"+r.value)).replace(/\/to\/[^\/]+/,"/to/"+i.value),document.querySelector("div.content-header td.form-buttons button").setAttribute("onclick",o),document.querySelector("div.content-header-floating td.form-buttons button").setAttribute("onclick",o)),this}};"function"==typeof self.addEventListener&&self.addEventListener("load",versioning.start.bind(versioning));