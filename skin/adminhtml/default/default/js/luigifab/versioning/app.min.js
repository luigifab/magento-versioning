/**
 * Copyright 2011-2018 | Fabrice Creuzot (luigifab) <code~luigifab~info>
 * https://www.luigifab.info/magento/versioning
 * This program is free software, you can redistribute it or modify
 * it under the terms of the GNU General Public License (GPL).
 */
var versioning={svg:null,width:197,decode:function(t){return decodeURIComponent(escape(window.atob(t)))},start:function(){document.querySelector('body[class*="adminhtml-versioning-repository-"]')&&(console.info("versioning.app - hello"),document.getElementById("versioning_history_grid")&&document.querySelector("table.data tbody button")&&document.querySelector("table.data tbody button").click(),document.getElementById("versioning_grid_table")&&"object"==typeof window.versioningIds&&(versioning.drawGraph(window.versioningIds,window.versioningCols),versioning.initDiff()))},enableLoader:function(){document.body.style.cursor="progress",document.querySelector("div.content-header td.form-buttons").setAttribute("style","visibility:hidden;"),document.querySelector("div.content-header-floating td.form-buttons").setAttribute("style","visibility:hidden;")},confirmFlag:function(e,t,o){try{if(apijs.version<530)throw new Error("Invalid apijs version");e.match(/revision\/([0-9a-z]+)\//),apijs.dialog.dialogConfirmation(t,this.decode(o),versioning.actionConfirmFlag,e,"notransition versioning "+document.getElementById("scmtype").textContent);var n=document.createElement("p");n.setAttribute("class","credits"),n.appendChild(document.createTextNode(window.versioningConfirm[1])),apijs.dialog.t1.appendChild(n)}catch(t){console.log(t);try{confirm(this.decode(o).replace(/\[[^\]]+\]/g,""))&&(this.enableLoader(),location.href=e)}catch(t){console.log(t),confirm(Translator.translate("Are you sure?"))&&(this.enableLoader(),location.href=e)}}},actionConfirmFlag:function(t){versioning.enableLoader(),apijs.dialog.styles.remove("waiting","lock"),location.href=t},cancelFlag:function(t){this.enableLoader(),location.href=t},confirmUpgrade:function(e,o){try{var n=window.versioningConfirm[0],i=window.versioningConfirm[1];if(apijs.version<530)throw new Error("Invalid apijs version");e.match(/revision\/([0-9a-z]+)\//),apijs.dialog.dialogFormOptions(o.replace("ยง",RegExp.$1),this.decode(n),e,versioning.actionConfirmUpgrade,null,"notransition versioning "+document.getElementById("scmtype").textContent);var t=document.createElement("p");return t.setAttribute("class","credits"),t.appendChild(document.createTextNode(i)),apijs.dialog.t1.appendChild(t),!1}catch(t){console.log(t);try{apijs.dialog.actionClose()}catch(t){}try{var r=document.createElement("div"),a=this.decode(n).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\[/g,"<").replace(/\]/g,">"),s=document.getElementById("scmtype").textContent;return e.match(/revision\/([0-9a-z]+)\//),r.innerHTML='<div class="fake options versioning '+s+' ready" id="apijsDialog"><form method="get" action="'+e+'" class="fake options versioning '+s+' ready" onsubmit="return versioning.actionConfirmUpgrade(true);" id="apijsBox"><h1>'+o.replace("ยง",RegExp.$1)+'</h1><div class="bbcode">'+a+'</div><div class="control"><button type="submit" class="confirm">Valider</button><button type="button" class="cancel" onclick="versioning.closeConfirmUpgrade();">Annuler</button></div></form><p class="credits">'+i+"</p></div>",document.body.appendChild(r),document.querySelector("div.bbcode input").focus(),!1}catch(t){return console.log(t),confirm(Translator.translate("Are you sure?"))}}},closeConfirmUpgrade:function(){document.getElementById("apijsDialog").parentNode.removeChild(document.getElementById("apijsDialog"))},actionConfirmUpgrade:function(t){return!1===t||(versioning.enableLoader(),!0===t?(document.querySelector("div.bbcode").setAttribute("style","visibility:hidden;"),document.querySelector("div.control").setAttribute("style","visibility:hidden;")):(apijs.dialog.styles.remove("waiting","lock"),location.href=t+apijs.serialize(document.getElementById("apijsBox")).replace(/=|&/g,"/"))),!0},history:function(t,e){var o,n=document.querySelectorAll("table.data tbody tr");for(o in n)n.hasOwnProperty(o)&&!isNaN(o)&&n[o].hasAttribute("class")&&n[o].setAttribute("class",n[o].getAttribute("class").replace(/ ?current/,""));return(o=t.parentNode.parentNode).setAttribute("class",(o.hasAttribute("class")?o.getAttribute("class"):"")+" current"),document.querySelector("pre").innerHTML=this.decode(e)+"\n\n",!1},drawGraph:function(t,e){var n,i,r,a,s,o=[],l=[],c=[],d=[],u=[],g="",p=versioning,h=new Hash(t),m=h.values(),v=$$("table.data tbody tr"),b=v.length-1,f=0,y=0,k=0,w=0,A=0,C=0;for(m.sort(function(t,e){return t.row>e.row?-1:t.row<e.row?1:0}),"function"==typeof Element.Layout?(y=v.first().getLayout().get("top")-1,k=v.last().getLayout().get("top")+v.last().getLayout().get("height")-y-1):(y=Element.positionedOffset(v.first())[1]-1,k=Element.positionedOffset(v.last())[1]+v.last().getDimensions().height-y-1),this.svg=new Raphael(document.getElementById("versioning_grid_table").parentNode),this.svg.setSize(this.width,k),this.svg.canvas.setAttribute("style","top:"+y+"px;"),this.svg.canvas.setAttribute("class","k k0"),this.svg.canvas.setAttribute("id","versioning_graph"),this.svg.canvas.setAttribute("onmouseover","versioning.mouseOver(true);"),this.svg.canvas.parentNode.setAttribute("onmouseleave","versioning.mouseOver(false);"),Raphael.getColor.reset(),Raphael.getColor(),o.push(Raphael.getColor()),i=0;i<=e;i++)Raphael.getColor(),Raphael.getColor(),o.push(Raphael.getColor()),l.push("svg.k"+i+" .k:not(.k"+i+") { opacity:0.4; }"),l.push("table.k"+i+" .k:not(.k"+i+") { color:#CCC; }"),l.push("table.k"+i+" .k:not(.k"+i+") button { opacity:0; visibility:hidden; }");m.each(function(t){t.color=o[t.col],t.klass="k k"+t.col,u[t.col]=t.revision,d[t.col]||(d[t.col]=t.revision)}),m.each(function(o){"function"==typeof Element.Layout?(w=v[b-o.row].getLayout().get("top")-y,A=v[b-o.row].getLayout().get("height")/2):(w=Element.positionedOffset(v[b-o.row])[1]-y,A=v[b-o.row].getDimensions().height/2),r=w+A,i=25*o.col+20,p.svg.circle(i,r,3.5).attr("fill",o.color).attr("stroke","none").attr("class",o.klass),0<o.branch.length&&c.indexOf(o.branch)<0&&(c.push(o.branch),n=p.svg.text(i+13,r-.3,o.branch).attr("fill",o.color).attr("text-anchor","start").attr("class",o.klass),a=i+3.2+8+n.getBBox().width+7,p.svg.path("M "+(i+3.2)+","+(r-.4)+" L "+(i+3.2+8)+","+(r-.4-8)+" L "+a+","+(r-.4-8)+" L "+a+","+(r-.4+8)+" L "+(i+3.2+8)+","+(r-.4+8)+" Z").attr("stroke",o.color).attr("fill","white").attr("fill-opacity","0.7").attr("stroke-opacity","0.2").attr("class",o.klass).toFront(),n.toFront(),a>versioning.width&&(versioning.width=a)),o.parents.each(function(t,e){"object"==typeof(e=0<t.length?h.get(t):void 0)?("function"==typeof Element.Layout?(w=v[b-e.row].getLayout().get("top")-y,A=v[b-e.row].getLayout().get("height")/2):(w=Element.positionedOffset(v[b-e.row])[1]-y,A=v[b-e.row].getDimensions().height/2),s=w+A,a=25*e.col+20,e.col===o.col?p.svg.path(["M",i,r,"V",s]).attr("stroke",o.color).attr("stroke-width",1.7).attr("class",o.klass).toBack():(g+='<linearGradient id="manGrad'+f+'" x1="0" y1="0" x2="100%" y2="0"><stop offset="0" stop-color="'+(a<i?e.color:o.color)+'"></stop><stop offset="100%" stop-color="'+(a<i?o.color:e.color)+'"></stop></linearGradient>',C="function"==typeof Element.Layout?v[b-e.row].getLayout().get("height")/2:v[b-e.row].getDimensions().height/2,C+=A,e.revision===d[e.col]&&r+C<s?((n=p.svg.path(["M",i,r,"T",a,r+C])).node.setAttribute("stroke","url(#manGrad"+f+")"),n.attr("stroke-width",1.6).attr("class","k").toBack(),p.svg.path(["M",a,r+C,"V",s]).attr("stroke",e.color).attr("stroke-width",1.7).attr("class","k").toBack()):(o.revision===u[o.col]&&r+C<s&&1===o.parents.length?(p.svg.path(["M",i,r,"V",s-C]).attr("stroke",o.color).attr("stroke-width",1.7).attr("class","k").toBack(),(n=p.svg.path(["M",i,s-C,"T",a,s])).node.setAttribute("stroke","url(#manGrad"+f+")")):(n=p.svg.path(["M",i,r,"T",a,s])).node.setAttribute("stroke","url(#manGrad"+f+")"),n.attr("stroke-width",1.6).attr("class","k").toBack()),f+=1)):0<t.length&&p.svg.path(["M",i,r,"V",k]).attr("stroke",o.color).attr("stroke-width",1.7).attr("class",o.klass).toBack()}),(n=v[b-o.row]).setAttribute("onclick","versioning.updateClass(this.getAttribute('class'));"),n.setAttribute("class",o.row%2<1?o.klass:"even "+o.klass),n.removeAttribute("title")}),0<g.length&&(document.querySelector("svg defs").innerSVG=g),(n=document.createElement("style")).setAttribute("type","text/css"),n.setAttribute("id","versioning_styles"),n.appendChild(document.createTextNode(l.join("\n"))),document.querySelector("head").appendChild(n)},mouseOver:function(t){this.svg.canvas.style.width=t?versioning.width+"px":"197px",this.svg.canvas.style.pointerEvents=t?"none":"inherit"},updateClass:function(t){this.svg.canvas.setAttribute("class",t),document.getElementById("versioning_grid_table").setAttribute("class","data "+t)},initDiff:function(){var t,e=document.querySelectorAll('table.data input[type="radio"]'),o=1,n=1,i=!0;for(t in e)e.hasOwnProperty(t)&&!isNaN(t)&&(e[t].setAttribute("onchange","versioning.goDiff("+(i?o++:n++)+", "+(i?"false":"true")+");"),e[t].removeAttribute("disabled"),i=!i);document.querySelector('table.data tr:last-child input[name="d1"]').setAttribute("disabled","disabled"),document.querySelector('table.data tr:first-child input[name="d2"]').setAttribute("disabled","disabled"),document.querySelector('table.data input[name="d1"]:not([disabled])').checked=!0,document.querySelector('table.data input[name="d2"]:not([disabled])').checked=!0,this.goDiff()},goDiff:function(t,e){var o,n=document.querySelector('table.data input[name="d1"]:checked'),i=document.querySelector('table.data input[name="d2"]:checked'),r=parseInt(n.getAttribute("onchange").replace(/[^0-9]/g,""),10),a=parseInt(i.getAttribute("onchange").replace(/[^0-9]/g,""),10);"string"==typeof t?(this.enableLoader(),location.href=t):(!0===e?a<=r&&((n=i.parentNode.parentNode.previousElementSibling.querySelector('input[name="d1"]')).checked=!0):a<=r&&((i=n.parentNode.parentNode.nextElementSibling.querySelector('input[name="d2"]')).checked=!0),o=(o=(o=document.querySelector("div.content-header td.form-buttons button").getAttribute("onclick")).replace(/from\/[^\/]+/,"from/"+i.value)).replace(/to\/[^\/]+/,"to/"+n.value),document.querySelector("div.content-header td.form-buttons button").setAttribute("onclick",o),document.querySelector("div.content-header-floating td.form-buttons button").setAttribute("onclick",o))}};"function"==typeof window.addEventListener&&window.addEventListener("load",versioning.start,!1);