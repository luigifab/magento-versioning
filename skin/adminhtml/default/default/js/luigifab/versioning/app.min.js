/**
 * Copyright 2011-2017 | Fabrice Creuzot (luigifab) <code~luigifab~info>
 * https://www.luigifab.info/magento/versioning
 * This program is free software, you can redistribute it or modify
 * it under the terms of the GNU General Public License (GPL).
 */
var versioning={decode:function(t){return decodeURIComponent(escape(window.atob(t)))},start:function(){document.querySelector('body[class*="adminhtml-versioning-repository-"]')&&(console.info("versioning.app - hello"),document.getElementById("history_grid")&&document.querySelector("table.data tbody button")&&document.querySelector("table.data tbody button").click(),document.getElementById("versioning_grid_table")&&"undefined"!=typeof versioningIds&&(versioning.drawGraph(versioningIds,versioningCols),versioning.initDiff()))},enableLoader:function(){document.body.style.cursor="progress",document.querySelector("div.content-header td.form-buttons").setAttribute("style","visibility:hidden"),document.querySelector("div.content-header-floating td.form-buttons").setAttribute("style","visibility:hidden")},confirmFlag:function(t,e,o,n){try{if(apijs.version<530)throw new Error("Invalid apijs version");t.match(/revision\/([0-9a-z]+)\//),apijs.dialog.dialogConfirmation(e,this.decode(o),versioning.actionConfirmFlag,t,"notransition versioning "+document.getElementById("scmtype").textContent);var r=document.createElement("p");r.setAttribute("class","credits"),r.appendChild(document.createTextNode(n)),apijs.dialog.t1.appendChild(r)}catch(e){console.log(e);try{confirm(this.decode(o).replace(/\[[^\]]+\]/g,""))&&(this.enableLoader(),location.href=t)}catch(e){console.log(e),confirm(Translator.translate("Are you sure?"))&&(this.enableLoader(),location.href=t)}}},actionConfirmFlag:function(t){versioning.enableLoader(),apijs.dialog.styles.remove("waiting","lock"),location.href=t},cancelFlag:function(t){this.enableLoader(),location.href=t},confirmUpgrade:function(t,e,o,n){try{if(apijs.version<530)throw new Error("Invalid apijs version");t.match(/revision\/([0-9a-z]+)\//),apijs.dialog.dialogFormOptions(e.replace("ยง",RegExp.$1),this.decode(o),t,versioning.actionConfirmUpgrade,null,"notransition versioning "+document.getElementById("scmtype").textContent);var r=document.createElement("p");return r.setAttribute("class","credits"),r.appendChild(document.createTextNode(n)),apijs.dialog.t1.appendChild(r),!1}catch(r){console.log(r);try{apijs.dialog.actionClose()}catch(t){}try{var i=document.createElement("div"),a=this.decode(o).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\[/g,"<").replace(/\]/g,">"),s=document.getElementById("scmtype").textContent;return t.match(/revision\/([0-9a-z]+)\//),i.innerHTML='<div class="fake options versioning '+s+' ready" id="apijsDialog"><form method="get" action="'+t+'" class="fake options versioning '+s+' ready" onsubmit="return versioning.actionConfirmUpgrade(true);" id="apijsBox"><h1>'+e.replace("ยง",RegExp.$1)+'</h1><div class="bbcode">'+a+'</div><div class="control"><button type="submit" class="confirm">Valider</button><button type="button" class="cancel" onclick="versioning.closeConfirmUpgrade();">Annuler</button></div></form><p class="credits">'+n+"</p></div>",document.body.appendChild(i),document.querySelector("div.bbcode input").focus(),!1}catch(t){return console.log(t),confirm(Translator.translate("Are you sure?"))}}},closeConfirmUpgrade:function(){document.getElementById("apijsDialog").parentNode.removeChild(document.getElementById("apijsDialog"))},actionConfirmUpgrade:function(t,e){return!1===t||(versioning.enableLoader(),!0===t?(document.querySelector("div.bbcode").setAttribute("style","visibility:hidden"),document.querySelector("div.control").setAttribute("style","visibility:hidden")):(apijs.dialog.styles.remove("waiting","lock"),location.href=t+apijs.serialize(document.getElementById("apijsBox")).replace(/=|&/g,"/")),!0)},history:function(t,e){var o,n=document.querySelectorAll("table.data tbody tr");for(o in n)n.hasOwnProperty(o)&&!isNaN(o)&&n[o].hasAttribute("class")&&n[o].setAttribute("class",n[o].getAttribute("class").replace(/ ?current/,""));return(o=t.parentNode.parentNode).setAttribute("class",(o.hasAttribute("class")?o.getAttribute("class"):"")+" current"),document.querySelector("pre").innerHTML=this.decode(e)+"\n\n",!1},drawGraph:function(t,e){var o,n,r,i,a,s,c,l=[],d=0,u=[],p="",g=new Hash(t),f=g.values(),m=g.keys().length-1,h=$$("table.data tbody tr"),y=0,b=0,v=0,w=0;for(f.sort(function(t,e){return t.row>e.row?-1:t.row<e.row?1:0}),"function"==typeof Element.Layout?(y=h.first().getLayout().get("top")-1,b=h.last().getLayout().get("top")+h.last().getLayout().get("height")-y-1):(y=Element.positionedOffset(h.first())[1]-1,b=Element.positionedOffset(h.last())[1]+h.last().getDimensions().height-y-1),(o=new Raphael(document.getElementById("versioning_grid_table").parentNode)).setSize(197,b),document.querySelector("svg").style.top=y+"px",Raphael.getColor.reset(),n=0;n<=e;n++)Raphael.getColor(),l.push(Raphael.getColor());f.each(function(t){"function"==typeof Element.Layout?(v=h[m-t.row].getLayout().get("top")-y,w=h[m-t.row].getLayout().get("height")/2):(v=Element.positionedOffset(h[m-t.row])[1]-y,w=h[m-t.row].getDimensions().height/2),i=v+w,r=25*t.col+20,o.circle(r,i,3.4).attr("fill",l[t.col]).attr("stroke","none"),t.branch.length>0&&u.indexOf(t.branch)<0&&(u.push(t.branch),c=o.text(r+13,i-.3,t.branch).attr("fill",l[t.col]).attr("text-anchor","start"),o.path("M "+(r+3.2)+","+(i-.4)+" L "+(r+3.2+8)+","+(i-.4-8)+" L "+(r+3.2+8+c.getBBox().width+7)+","+(i-.4-8)+" L "+(r+3.2+8+c.getBBox().width+7)+","+(i-.4+8)+" L "+(r+3.2+8)+","+(i-.4+8)+" Z").attr("stroke",l[t.col]).attr("fill","white").attr("fill-opacity","0.7").attr("stroke-opacity","0.2").toFront(),c.toFront(),(n=r+3.2+8+c.getBBox().width+7)>197&&(document.querySelector("svg").setAttribute("onmouseover",'this.style.width = "'+n+'px";'),document.querySelector("svg").setAttribute("onmouseout",'this.style.width = "197px";'),document.querySelector("svg").style.pointerEvents="inherit")),t.parents.each(function(e,n){"object"==typeof(n=e.length>0?g.get(e):void 0)?("function"==typeof Element.Layout?(v=h[m-n.row].getLayout().get("top")-y,w=h[m-n.row].getLayout().get("height")/2):(v=Element.positionedOffset(h[m-n.row])[1]-y,w=h[m-n.row].getDimensions().height/2),s=v+w,a=25*n.col+20,n.col===t.col?o.path(["M",r,i,"V",s]).attr("stroke",l[t.col]).attr("stroke-width",1.7).toBack():(p+=r>a?'<linearGradient id="manGrad'+d+'" x1="0" y1="0" x2="100%" y2="0"><stop offset="0" stop-color="'+l[n.col]+'"></stop><stop offset="100%" stop-color="'+l[t.col]+'"></stop></linearGradient>':'<linearGradient id="manGrad'+d+'" x1="0" y1="0" x2="100%" y2="0"><stop offset="0" stop-color="'+l[t.col]+'"></stop><stop offset="100%" stop-color="'+l[n.col]+'"></stop></linearGradient>',i+4*w<s?(s=i+3*w,(c=o.path(["M",r,i,"C",r,i,r,i+(s-i)/2,r+(a-r)/2,i+(s-i)/2,"C",r+(a-r)/2,i+(s-i)/2,a,s-(s-i)/2,a,s])).node.setAttribute("stroke","url(#manGrad"+d+")"),c.attr("stroke-width",1.7).toBack(),i+=3*w,s=v+w,o.path(["M",a,i,"V",s]).attr("stroke",l[n.col]).attr("stroke-width",1.7).toBack()):((c=o.path(["M",r,i,"C",r,i,r,i+(s-i)/2,r+(a-r)/2,i+(s-i)/2,"C",r+(a-r)/2,i+(s-i)/2,a,s-(s-i)/2,a,s])).node.setAttribute("stroke","url(#manGrad"+d+")"),c.attr("stroke-width",1.7).toBack()),d+=1)):e.length>0&&o.path(["M",r,i,"V",b]).attr("stroke",l[t.col]).attr("stroke-width",1.7).toBack()}),t.col>0&&h[m-t.row].setAttribute("class",h[m-t.row].getAttribute("class")+" outside")}),p.length>0&&(document.querySelector("svg defs").innerSVG=p)},initDiff:function(){var t,e=document.querySelectorAll('table.data input[type="radio"]'),o=1,n=1,r=!0;for(t in e)e.hasOwnProperty(t)&&!isNaN(t)&&(e[t].setAttribute("onchange","versioning.goDiff("+(r?o++:n++)+", "+(r?"false":"true")+");"),e[t].removeAttribute("disabled"),r=!r);document.querySelector('table.data tr:last-child input[name="diff1"]').setAttribute("disabled","disabled"),document.querySelector('table.data tr:first-child input[name="diff2"]').setAttribute("disabled","disabled"),document.querySelector('table.data input[name="diff1"]:not([disabled])').checked=!0,document.querySelector('table.data input[name="diff2"]:not([disabled])').checked=!0,this.goDiff()},goDiff:function(t,e){var o,n=document.querySelector('table.data input[name="diff1"]:checked'),r=document.querySelector('table.data input[name="diff2"]:checked'),i=parseInt(n.getAttribute("onchange").replace(/[^0-9]/g,""),10),a=parseInt(r.getAttribute("onchange").replace(/[^0-9]/g,""),10);"string"==typeof t?(this.enableLoader(),location.href=t):(!0===e?i>=a&&((n=r.parentNode.parentNode.previousElementSibling.querySelector('input[name="diff1"]')).checked=!0):i>=a&&((r=n.parentNode.parentNode.nextElementSibling.querySelector('input[name="diff2"]')).checked=!0),o=(o=(o=document.querySelector("div.content-header td.form-buttons button").getAttribute("onclick")).replace(/from\/[^\/]+/,"from/"+r.value)).replace(/to\/[^\/]+/,"to/"+n.value),document.querySelector("div.content-header td.form-buttons button").setAttribute("onclick",o),document.querySelector("div.content-header-floating td.form-buttons button").setAttribute("onclick",o))}};"function"==typeof window.addEventListener&&window.addEventListener("load",versioning.start,!1);