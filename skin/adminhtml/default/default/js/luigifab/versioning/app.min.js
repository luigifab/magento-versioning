/**
 * Copyright 2011-2018 | Fabrice Creuzot (luigifab) <code~luigifab~info>
 * https://www.luigifab.info/magento/versioning
 * This program is free software, you can redistribute it or modify
 * it under the terms of the GNU General Public License (GPL).
 */
var versioning={svg:null,width:197,decode:function(t){return decodeURIComponent(escape(window.atob(t)))},start:function(){document.querySelector('body[class*="adminhtml-versioning-repository-"]')&&(console.info("versioning.app - hello"),document.getElementById("versioning_history_grid")&&document.querySelector("table.data tbody button")&&document.querySelector("table.data tbody button").click(),document.getElementById("versioning_grid_table")&&"undefined"!=typeof versioningIds&&(versioning.drawGraph(versioningIds,versioningCols),versioning.initDiff()))},enableLoader:function(){document.body.style.cursor="progress",document.querySelector("div.content-header td.form-buttons").setAttribute("style","visibility:hidden;"),document.querySelector("div.content-header-floating td.form-buttons").setAttribute("style","visibility:hidden;")},confirmFlag:function(t,e,o,n){try{if(apijs.version<530)throw new Error("Invalid apijs version");t.match(/revision\/([0-9a-z]+)\//),apijs.dialog.dialogConfirmation(e,this.decode(o),versioning.actionConfirmFlag,t,"notransition versioning "+document.getElementById("scmtype").textContent);var i=document.createElement("p");i.setAttribute("class","credits"),i.appendChild(document.createTextNode(n)),apijs.dialog.t1.appendChild(i)}catch(e){console.log(e);try{confirm(this.decode(o).replace(/\[[^\]]+\]/g,""))&&(this.enableLoader(),location.href=t)}catch(e){console.log(e),confirm(Translator.translate("Are you sure?"))&&(this.enableLoader(),location.href=t)}}},actionConfirmFlag:function(t){versioning.enableLoader(),apijs.dialog.styles.remove("waiting","lock"),location.href=t},cancelFlag:function(t){this.enableLoader(),location.href=t},confirmUpgrade:function(t,e,o,n){try{if(apijs.version<530)throw new Error("Invalid apijs version");t.match(/revision\/([0-9a-z]+)\//),apijs.dialog.dialogFormOptions(e.replace("ยง",RegExp.$1),this.decode(o),t,versioning.actionConfirmUpgrade,null,"notransition versioning "+document.getElementById("scmtype").textContent);var i=document.createElement("p");return i.setAttribute("class","credits"),i.appendChild(document.createTextNode(n)),apijs.dialog.t1.appendChild(i),!1}catch(i){console.log(i);try{apijs.dialog.actionClose()}catch(t){}try{var r=document.createElement("div"),a=this.decode(o).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\[/g,"<").replace(/\]/g,">"),s=document.getElementById("scmtype").textContent;return t.match(/revision\/([0-9a-z]+)\//),r.innerHTML='<div class="fake options versioning '+s+' ready" id="apijsDialog"><form method="get" action="'+t+'" class="fake options versioning '+s+' ready" onsubmit="return versioning.actionConfirmUpgrade(true);" id="apijsBox"><h1>'+e.replace("ยง",RegExp.$1)+'</h1><div class="bbcode">'+a+'</div><div class="control"><button type="submit" class="confirm">Valider</button><button type="button" class="cancel" onclick="versioning.closeConfirmUpgrade();">Annuler</button></div></form><p class="credits">'+n+"</p></div>",document.body.appendChild(r),document.querySelector("div.bbcode input").focus(),!1}catch(t){return console.log(t),confirm(Translator.translate("Are you sure?"))}}},closeConfirmUpgrade:function(){document.getElementById("apijsDialog").parentNode.removeChild(document.getElementById("apijsDialog"))},actionConfirmUpgrade:function(t){return!1===t||(versioning.enableLoader(),!0===t?(document.querySelector("div.bbcode").setAttribute("style","visibility:hidden;"),document.querySelector("div.control").setAttribute("style","visibility:hidden;")):(apijs.dialog.styles.remove("waiting","lock"),location.href=t+apijs.serialize(document.getElementById("apijsBox")).replace(/=|&/g,"/")),!0)},history:function(t,e){var o,n=document.querySelectorAll("table.data tbody tr");for(o in n)n.hasOwnProperty(o)&&!isNaN(o)&&n[o].hasAttribute("class")&&n[o].setAttribute("class",n[o].getAttribute("class").replace(/ ?current/,""));return(o=t.parentNode.parentNode).setAttribute("class",(o.hasAttribute("class")?o.getAttribute("class"):"")+" current"),document.querySelector("pre").innerHTML=this.decode(e)+"\n\n",!1},drawGraph:function(t,e){var o,n,i,r,a,s=[],l=[],c=[],d=[],u=[],g="",p=versioning,h=new Hash(t),m=h.values(),v=$$("table.data tbody tr"),f=v.length-1,b=0,y=0,k=0,w=0,A=0,C=0;for(m.sort(function(t,e){return t.row>e.row?-1:t.row<e.row?1:0}),"function"==typeof Element.Layout?(y=v.first().getLayout().get("top")-1,k=v.last().getLayout().get("top")+v.last().getLayout().get("height")-y-1):(y=Element.positionedOffset(v.first())[1]-1,k=Element.positionedOffset(v.last())[1]+v.last().getDimensions().height-y-1),this.svg=new Raphael(document.getElementById("versioning_grid_table").parentNode),this.svg.setSize(this.width,k),this.svg.canvas.setAttribute("style","top:"+y+"px;"),this.svg.canvas.setAttribute("class","k k0"),this.svg.canvas.setAttribute("id","versioning_graph"),this.svg.canvas.setAttribute("onmouseover","versioning.mouseOver(true);"),this.svg.canvas.parentNode.setAttribute("onmouseleave","versioning.mouseOver(false);"),Raphael.getColor.reset(),Raphael.getColor(),s.push(Raphael.getColor()),n=0;n<=e;n++)Raphael.getColor(),Raphael.getColor(),s.push(Raphael.getColor()),l.push("svg.k"+n+" .k:not(.k"+n+") { opacity:0.4; }"),l.push("table.k"+n+" .k:not(.k"+n+") { color:#CCC; }"),l.push("table.k"+n+" .k:not(.k"+n+") button { opacity:0; visibility:hidden; }");m.each(function(t){t.color=s[t.col],t.klass="k k"+t.col,u[t.col]=t.revision,d[t.col]||(d[t.col]=t.revision)}),m.each(function(t){"function"==typeof Element.Layout?(w=v[f-t.row].getLayout().get("top")-y,A=v[f-t.row].getLayout().get("height")/2):(w=Element.positionedOffset(v[f-t.row])[1]-y,A=v[f-t.row].getDimensions().height/2),i=w+A,n=25*t.col+20,p.svg.circle(n,i,3.5).attr("fill",t.color).attr("stroke","none").attr("class",t.klass),t.branch.length>0&&c.indexOf(t.branch)<0&&(c.push(t.branch),o=p.svg.text(n+13,i-.3,t.branch).attr("fill",t.color).attr("text-anchor","start").attr("class",t.klass),r=n+3.2+8+o.getBBox().width+7,p.svg.path("M "+(n+3.2)+","+(i-.4)+" L "+(n+3.2+8)+","+(i-.4-8)+" L "+r+","+(i-.4-8)+" L "+r+","+(i-.4+8)+" L "+(n+3.2+8)+","+(i-.4+8)+" Z").attr("stroke",t.color).attr("fill","white").attr("fill-opacity","0.7").attr("stroke-opacity","0.2").attr("class",t.klass).toFront(),o.toFront(),r>versioning.width&&(versioning.width=r)),t.parents.each(function(e,s){"object"==typeof(s=e.length>0?h.get(e):void 0)?("function"==typeof Element.Layout?(w=v[f-s.row].getLayout().get("top")-y,A=v[f-s.row].getLayout().get("height")/2):(w=Element.positionedOffset(v[f-s.row])[1]-y,A=v[f-s.row].getDimensions().height/2),a=w+A,r=25*s.col+20,s.col===t.col?p.svg.path(["M",n,i,"V",a]).attr("stroke",t.color).attr("stroke-width",1.7).attr("class",t.klass).toBack():(g+='<linearGradient id="manGrad'+b+'" x1="0" y1="0" x2="100%" y2="0"><stop offset="0" stop-color="'+(n>r?s.color:t.color)+'"></stop><stop offset="100%" stop-color="'+(n>r?t.color:s.color)+'"></stop></linearGradient>',C="function"==typeof Element.Layout?v[f-s.row].getLayout().get("height")/2:v[f-s.row].getDimensions().height/2,C+=A,s.revision===d[s.col]&&i+C<a?((o=p.svg.path(["M",n,i,"T",r,i+C])).node.setAttribute("stroke","url(#manGrad"+b+")"),o.attr("stroke-width",1.6).attr("class","k").toBack(),p.svg.path(["M",r,i+C,"V",a]).attr("stroke",s.color).attr("stroke-width",1.7).attr("class","k").toBack()):t.revision===u[t.col]&&a>i+C&&1===t.parents.length?(p.svg.path(["M",n,i,"V",a-C]).attr("stroke",t.color).attr("stroke-width",1.7).attr("class","k").toBack(),(o=p.svg.path(["M",n,a-C,"T",r,a])).node.setAttribute("stroke","url(#manGrad"+b+")"),o.attr("stroke-width",1.6).attr("class","k").toBack()):((o=p.svg.path(["M",n,i,"T",r,a])).node.setAttribute("stroke","url(#manGrad"+b+")"),o.attr("stroke-width",1.6).attr("class","k").toBack()),b+=1)):e.length>0&&p.svg.path(["M",n,i,"V",k]).attr("stroke",t.color).attr("stroke-width",1.7).attr("class",t.klass).toBack()}),(o=v[f-t.row]).setAttribute("onclick","versioning.updateClass(this.getAttribute('class'));"),o.setAttribute("class",t.row%2<1?t.klass:"even "+t.klass),o.removeAttribute("title")}),g.length>0&&(document.querySelector("svg defs").innerSVG=g),(o=document.createElement("style")).setAttribute("type","text/css"),o.setAttribute("id","versioning_styles"),o.appendChild(document.createTextNode(l.join("\n"))),document.querySelector("head").appendChild(o)},mouseOver:function(t){this.svg.canvas.style.width=t?versioning.width+"px":"197px",this.svg.canvas.style.pointerEvents=t?"none":"inherit"},updateClass:function(t){this.svg.canvas.setAttribute("class",t),document.getElementById("versioning_grid_table").setAttribute("class","data "+t)},initDiff:function(){var t,e=document.querySelectorAll('table.data input[type="radio"]'),o=1,n=1,i=!0;for(t in e)e.hasOwnProperty(t)&&!isNaN(t)&&(e[t].setAttribute("onchange","versioning.goDiff("+(i?o++:n++)+", "+(i?"false":"true")+");"),e[t].removeAttribute("disabled"),i=!i);document.querySelector('table.data tr:last-child input[name="diff1"]').setAttribute("disabled","disabled"),document.querySelector('table.data tr:first-child input[name="diff2"]').setAttribute("disabled","disabled"),document.querySelector('table.data input[name="diff1"]:not([disabled])').checked=!0,document.querySelector('table.data input[name="diff2"]:not([disabled])').checked=!0,this.goDiff()},goDiff:function(t,e){var o,n=document.querySelector('table.data input[name="diff1"]:checked'),i=document.querySelector('table.data input[name="diff2"]:checked'),r=parseInt(n.getAttribute("onchange").replace(/[^0-9]/g,""),10),a=parseInt(i.getAttribute("onchange").replace(/[^0-9]/g,""),10);"string"==typeof t?(this.enableLoader(),location.href=t):(!0===e?r>=a&&((n=i.parentNode.parentNode.previousElementSibling.querySelector('input[name="diff1"]')).checked=!0):r>=a&&((i=n.parentNode.parentNode.nextElementSibling.querySelector('input[name="diff2"]')).checked=!0),o=(o=(o=document.querySelector("div.content-header td.form-buttons button").getAttribute("onclick")).replace(/from\/[^\/]+/,"from/"+i.value)).replace(/to\/[^\/]+/,"to/"+n.value),document.querySelector("div.content-header td.form-buttons button").setAttribute("onclick",o),document.querySelector("div.content-header-floating td.form-buttons button").setAttribute("onclick",o))}};"function"==typeof window.addEventListener&&window.addEventListener("load",versioning.start,!1);