/**
 * Copyright 2011-2016 | Fabrice Creuzot (luigifab) <code~luigifab~info>
 * (3.4.0) https://redmine.luigifab.info/projects/magento/wiki/versioning
 *
 * This program is free software, you can redistribute it or modify
 * it under the terms of the GNU General Public License (GPL).
 */
var versioning={decode:function(data){return decodeURIComponent(escape(window.atob(data)))},start:function(){if(!document.querySelector('body[class*="adminhtml-versioning-repository-"]'))return;console.info('versioning.app hello!');if(document.getElementById('history_grid'))document.querySelector('table.data tbody tr td a').click();if(typeof versioningIds!=='undefined'){versioning.drawGraph(versioningIds,versioningCols);versioning.initDiff()}},confirmFlag:function(that,url,title,content,credits){that.blur();try{if(apijs.version<520)throw new Error('Invalid apijs version');url.match(/revision\/([0-9a-z]+)\//);apijs.dialog.dialogConfirmation(title,this.decode(content),versioning.actionConfirmFlag,url,'notransition versioning '+document.getElementById('scmtype').textContent);var elem=document.createElement('p');elem.setAttribute('class','credits');elem.appendChild(document.createTextNode(credits));document.getElementById('apijsDialog').appendChild(elem)}catch(e){console.log(e);try{if(confirm(this.decode(content).replace(/\[[^\]]+\]/g,''))){location.href=url;that.parentNode.style.visibility='hidden'}}catch(ee){console.log(ee);location.href=url;that.parentNode.style.visibility='hidden'}}},actionConfirmFlag:function(url){apijs.dialog.styles.remove('lock');location.href=url},cancelFlag:function(that,url){that.blur();that.parentNode.style.visibility='hidden';location.href=url},confirmUpgrade:function(url,title,content,credits){try{if(apijs.version>=520){url.match(/revision\/([0-9a-z]+)\//);apijs.dialog.dialogFormOptions(title.replace('ยง',RegExp.$1),this.decode(content),url,versioning.actionConfirmUpgrade,null,'notransition versioning '+document.getElementById('scmtype').textContent);var elem=document.createElement('p');elem.setAttribute('class','credits');elem.appendChild(document.createTextNode(credits));document.getElementById('apijsDialog').appendChild(elem);window.setTimeout(function(){document.querySelector('button.confirm').focus()},100);return false}}catch(e){console.log(e)}},actionConfirmUpgrade:function(action){if(action===false)return true;apijs.dialog.styles.remove('lock');location.href=action+'confirm/1/'+apijs.serialize(document.getElementById('apijsBox')).replace(/=|&/g,'/')},valid:function(data){document.querySelector('form div.bbcode').style.visibility='hidden';document.querySelector('form').removeChild(document.querySelector('form div.buttons'));if(data.indexOf('http')<0){var elem=document.createElement('p');elem.setAttribute('class','saving');elem.appendChild(document.createTextNode(data));document.querySelector('form').appendChild(elem)}else location.href=data},history:function(link,content){var elems=document.querySelectorAll('table.data tbody tr'),elem;for(elem in elems)if(elems.hasOwnProperty(elem)&&!isNaN(elem))if(elems[elem].hasAttribute('class'))elems[elem].setAttribute('class',elems[elem].getAttribute('class').replace(/ ?current/,''));elem=link.parentNode.parentNode;elem.setAttribute('class',((elem.hasAttribute('class'))?elem.getAttribute('class'):'')+' current');document.querySelector('pre').innerHTML=this.decode(content)+"\n\n";return false},drawGraph:function(data,cols){var graph,colors=[],k,x,y,pX,pY,elem,grad=0,names=[],alone,commitsHash=new Hash(data),commitsArray=commitsHash.values(),rows=commitsHash.keys().length-1,tableRows=$$('#versioning_grid_table tbody tr'),offsetTop=0,graphHeight=0,topPoint=0,miHeight=0;if(typeof Element.Layout==='function'){offsetTop=tableRows.first().getLayout().get('top')-1;graphHeight=tableRows.last().getLayout().get('top')+tableRows.last().getLayout().get('height')-offsetTop-1}else{offsetTop=Position.positionedOffset(tableRows.first())[1]-1;graphHeight=Position.positionedOffset(tableRows.last())[1]+tableRows.last().getDimensions().height-offsetTop-1};graph=new Raphael(document.getElementById('versioning_grid_table').parentNode);graph.setSize(197,graphHeight);document.querySelector('svg').style.top=offsetTop+'px';document.querySelector('svg defs').innerSVG='';Raphael.getColor.reset();for(k=0;k<=cols;k++){Raphael.getColor();colors.push(Raphael.getColor())};commitsArray.each(function(commit){if(typeof Element.Layout==='function'){topPoint=tableRows[rows-commit.row].getLayout().get('top')-offsetTop;miHeight=tableRows[rows-commit.row].getLayout().get('height')/2}else{topPoint=Position.positionedOffset(tableRows[rows-commit.row])[1]-offsetTop;miHeight=tableRows[rows-commit.row].getDimensions().height/2};y=topPoint+miHeight;x=25*commit.col+20;graph.circle(x,y,3.4).attr('fill',colors[commit.col]).attr('stroke','none');if((commit.refs.length>0)&&(names.indexOf(commit.refs)<0)){names.push(commit.refs);elem=graph.text(x+13,y-0.3,commit.refs).attr('fill',colors[commit.col]).attr('text-anchor','start');graph.path('M '+(x+3.2)+','+(y-0.4)+' L '+(x+3.2+8)+','+(y-0.4-8)+' L '+(x+3.2+8+elem.getBBox().width+7)+','+(y-0.4-8)+' L '+(x+3.2+8+elem.getBBox().width+7)+','+(y-0.4+8)+' L '+(x+3.2+8)+','+(y-0.4+8)+' Z').attr('stroke',colors[commit.col]).attr('fill','white').attr('fill-opacity','0.7').attr('stroke-opacity','0.2').toFront();elem.toFront();if((k=(x+3.2+8+elem.getBBox().width+7))>197){document.querySelector('svg').setAttribute('onmouseover','this.style.width = "'+k+'px";');document.querySelector('svg').setAttribute('onmouseout','this.style.width = "197px";');document.querySelector('svg').style.pointerEvents='inherit'}};commit.parents.each(function(ref,parent){parent=(ref.length>0)?commitsHash.get(ref):undefined;if(typeof parent==='object'){if(typeof Element.Layout==='function'){topPoint=tableRows[rows-parent.row].getLayout().get('top')-offsetTop;miHeight=tableRows[rows-parent.row].getLayout().get('height')/2}else{topPoint=Position.positionedOffset(tableRows[rows-parent.row])[1]-offsetTop;miHeight=tableRows[rows-parent.row].getDimensions().height/2};pY=topPoint+miHeight;pX=25*parent.col+20;if(parent.col===commit.col){graph.path(['M',x,y,'V',pY]).attr('stroke',colors[commit.col]).attr('stroke-width',1.7).toBack()}else{if(x>pX){document.querySelector('svg defs').innerSVG+='<linearGradient id="manGrad'+grad+'" x1="0" y1="0" x2="100%" y2="0"><stop offset="0" stop-color="'+colors[parent.col]+'"></stop><stop offset="100%" stop-color="'+colors[commit.col]+'"></stop></linearGradient>'}else document.querySelector('svg defs').innerSVG+='<linearGradient id="manGrad'+grad+'" x1="0" y1="0" x2="100%" y2="0"><stop offset="0" stop-color="'+colors[commit.col]+'"></stop><stop offset="100%" stop-color="'+colors[parent.col]+'"></stop></linearGradient>';alone=false;if((parent.parents.length===1)&&((y+miHeight*4)<pY)){alone=true;commitsArray.each(function(test){if((test.revision!==commit.revision)&&(test.parents.indexOf(parent.revision)>-1)){alone=false;throw $break}})};if(alone===true){pY=y+3*miHeight;elem=graph.path(['M',x,y,'C',x,y,x,y+(pY-y)/2,x+(pX-x)/2,y+(pY-y)/2,'C',x+(pX-x)/2,y+(pY-y)/2,pX,pY-(pY-y)/2,pX,pY]);elem.node.setAttribute('stroke','url(#manGrad'+grad+')');elem.attr('stroke-width',1.7).toBack();y=y+3*miHeight;pY=topPoint+miHeight;graph.path(['M',pX,y,'V',pY]).attr('stroke',colors[parent.col]).attr('stroke-width',1.7).toBack()}else{elem=graph.path(['M',x,y,'C',x,y,x,y+(pY-y)/2,x+(pX-x)/2,y+(pY-y)/2,'C',x+(pX-x)/2,y+(pY-y)/2,pX,pY-(pY-y)/2,pX,pY]);elem.node.setAttribute('stroke','url(#manGrad'+grad+')');elem.attr('stroke-width',1.7).toBack()};grad+=1}}else if(ref.length>0)graph.path(['M',x,y,'V',graphHeight]).attr('stroke',colors[commit.col]).attr('stroke-width',1.7).toBack()});if(versioningCurrentCol!==commit.col)tableRows[rows-commit.row].setAttribute('class',tableRows[rows-commit.row].getAttribute('class')+' outside')})},initDiff:function(){var elems=document.querySelectorAll('table.data input[type="radio"]'),elem;for(elem in elems)if(elems.hasOwnProperty(elem)&&!isNaN(elem))elems[elem].setAttribute('onchange','versioning.goDiff();')},goDiff:function(url){var diff1=document.querySelector('input[name="diff1"]:checked'),diff2=document.querySelector('input[name="diff2"]:checked'),onclick;if(diff1&&diff2){if(typeof url==='string'){location.href=url}else{onclick=document.querySelector('td.form-buttons button').getAttribute('onclick');onclick=onclick.replace(/from\/[^\/]+/,'from/'+diff2.value);onclick=onclick.replace(/to\/[^\/]+/,'to/'+diff1.value);document.querySelector('td.form-buttons button').setAttribute('class','scalable');document.querySelector('td.form-buttons button').setAttribute('onclick',onclick)}}else document.querySelector('td.form-buttons button').setAttribute('class','scalable disabled')}};if(typeof window.addEventListener==='function')window.addEventListener('load',versioning.start,false)